'use strict';var PDFFindController={startedTextExtraction:false,extractTextPromises:[],pendingFindMatches:{},active:false,pageContents:[],pageMatches:[],selected:{pageIdx:-1,matchIdx:-1},offset:{pageIdx:null,matchIdx:null},resumePageIdx:null,resumeCallback:null,state:null,dirtyMatch:false,findTimeout:null,pdfPageSource:null,integratedFind:false,firstPagePromise:new PDFJS.Promise(),initialize:function(a){if(typeof PDFFindBar==='undefined'||PDFFindBar===null)throw 'PDFFindController cannot be initialized '+'without a PDFFindController instance';this.pdfPageSource=a.pdfPageSource;this.integratedFind=a.integratedFind;var b=['find','findagain','findhighlightallchange','findcasesensitivitychange'];this.handleEvent=this.handleEvent.bind(this);for(var c=0;c<b.length;c++)window.addEventListener(b[c],this.handleEvent);},reset:function pdfFindControllerReset(){this.startedTextExtraction=false;this.extractTextPromises=[];this.active=false;},calcFindMatch:function(a){var b=this.pageContents[a];var c=this.state.query;var d=this.state.caseSensitive;var e=c.length;if(e===0)return;if(!d){b=b.toLowerCase();c=c.toLowerCase();}var f=[];var g=-e;while(true){g=b.indexOf(c,g+e);if(g===-1)break;f.push(g);}this.pageMatches[a]=f;this.updatePage(a);if(this.resumePageIdx===a){var h=this.resumeCallback;this.resumePageIdx=null;this.resumeCallback=null;h();}},extractText:function(){if(this.startedTextExtraction)return;this.startedTextExtraction=true;this.pageContents=[];for(var a=0,b=this.pdfPageSource.pdfDocument.numPages;a<b;a++)this.extractTextPromises.push(new PDFJS.Promise());var c=this;function d(a){c.pdfPageSource.pages[a].getTextContent().then(function b(b){var e=b.bidiTexts;var f='';for(var g=0;g<e.length;g++)f+=e[g].str;c.pageContents.push(f);c.extractTextPromises[a].resolve(a);if((a+1)<c.pdfPageSource.pages.length)d(a+1);});}d(0);},handleEvent:function(a){if(this.state===null||a.type!=='findagain')this.dirtyMatch=true;this.state=a.detail;this.updateUIState(FindStates.FIND_PENDING);this.firstPagePromise.then(function(){this.extractText();clearTimeout(this.findTimeout);if(a.type==='find')this.findTimeout=setTimeout(this.nextMatch.bind(this),250);else this.nextMatch();}.bind(this));},updatePage:function(a){var b=this.pdfPageSource.pages[a];if(this.selected.pageIdx===a)b.scrollIntoView();if(b.textLayer)b.textLayer.updateMatches();},nextMatch:function(){var a=this.state.findPrevious;var b=this.pdfPageSource.page-1;var c=this.pdfPageSource.pages.length;this.active=true;if(this.dirtyMatch){this.dirtyMatch=false;this.selected.pageIdx=this.selected.matchIdx=-1;this.offset.pageIdx=b;this.offset.matchIdx=null;this.hadMatch=false;this.resumeCallback=null;this.resumePageIdx=null;this.pageMatches=[];var d=this;for(var e=0;e<c;e++){this.updatePage(e);if(!(e in this.pendingFindMatches)){this.pendingFindMatches[e]=true;this.extractTextPromises[e].then(function(a){delete d.pendingFindMatches[a];d.calcFindMatch(a);});}}}if(this.state.query===''){this.updateUIState(FindStates.FIND_FOUND);return;}if(this.resumeCallback)return;var f=this.offset;if(f.matchIdx!==null){var g=this.pageMatches[f.pageIdx].length;if((!a&&f.matchIdx+1<g)||(a&&f.matchIdx>0)){this.hadMatch=true;f.matchIdx=a?f.matchIdx-1:f.matchIdx+1;this.updateMatch(true);return;}this.advanceOffsetPage(a);}this.nextPageMatch();},nextPageMatch:function(){if(this.resumePageIdx!==null)console.error('There can only be one pending page.');var a=function(a){var b=this.offset;var c=a.length;var d=this.state.findPrevious;if(c){this.hadMatch=true;b.matchIdx=d?c-1:0;this.updateMatch(true);}else{this.advanceOffsetPage(d);if(b.wrapped){b.matchIdx=null;if(!this.hadMatch){this.updateMatch(false);return;}}this.nextPageMatch();}}.bind(this);var b=this.offset.pageIdx;var c=this.pageMatches;if(!c[b]){this.resumeCallback=function(){a(c[b]);};this.resumePageIdx=b;return;}a(c[b]);},advanceOffsetPage:function(a){var b=this.offset;var c=this.extractTextPromises.length;b.pageIdx=a?b.pageIdx-1:b.pageIdx+1;b.matchIdx=null;if(b.pageIdx>=c||b.pageIdx<0){b.pageIdx=a?c-1:0;b.wrapped=true;return;}},updateMatch:function(a){var b=FindStates.FIND_NOTFOUND;var c=this.offset.wrapped;this.offset.wrapped=false;if(a){var d=this.selected.pageIdx;this.selected.pageIdx=this.offset.pageIdx;this.selected.matchIdx=this.offset.matchIdx;b=c?FindStates.FIND_WRAPPED:FindStates.FIND_FOUND;if(d!==-1&&d!==this.selected.pageIdx)this.updatePage(d);}this.updateUIState(b,this.state.findPrevious);if(this.selected.pageIdx!==-1)this.updatePage(this.selected.pageIdx,true);},updateUIState:function(a,b){if(this.integratedFind){FirefoxCom.request('updateFindControlState',{result:a,findPrevious:b});return;}PDFFindBar.updateUIState(a,b);}};